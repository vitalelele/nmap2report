import re
from defusedxml import ElementTree as ET

def parse_nmap_xml(file_path):
    """
    Parsea un file XML di Nmap (opzione -oX) ed estrae host, porte, servizi e vulnerabilità.
    Restituisce un dizionario con chiavi 'hosts' e 'stats'.
    """
    # Legge il contenuto XML dal file in modo sicuro
    try:
        tree = ET.parse(file_path)
    except ET.ParseError as e:
        raise Exception(f"XML non valido: {e}")
    root = tree.getroot()

    result = {"hosts": [], "stats": {}}

    # Estrae statistiche generali (numero di host up/down/total)
    hosts_stats = root.find("runstats/hosts")
    if hosts_stats is not None:
        result["stats"]["up"] = int(hosts_stats.get("up", 0))
        result["stats"]["down"] = int(hosts_stats.get("down", 0))
        result["stats"]["total"] = int(hosts_stats.get("total", 0))

    # Itera su ciascun host nel file XML
    for host in root.findall("host"):
        # Considera solo host attivi (stato "up")
        status = host.find("status")
        state = status.get("state") if status is not None else None
        if state != "up":
            continue

        # Estrae l'indirizzo IP (preferibilmente IPv4, altrimenti IPv6)
        ip_address = None
        for addr in host.findall("address"):
            atype = addr.get("addrtype")
            if atype == "ipv4":
                ip_address = addr.get("addr")
                break
            elif atype == "ipv6" and ip_address is None:
                ip_address = addr.get("addr")
        # Se non trovato IPv4/IPv6, ip_address rimane None

        # Estrae tutti gli hostnames (se presenti)
        hostnames_elem = host.find("hostnames")
        hostnames = []
        if hostnames_elem is not None:
            for hn in hostnames_elem.findall("hostname"):
                name = hn.get("name")
                if name:
                    hostnames.append(name)

        # Estrae le informazioni sulle porte
        ports_list = []
        ports_elem = host.find("ports")
        if ports_elem is not None:
            for port in ports_elem.findall("port"):
                # Considera solo le porte con stato "open"
                state_elem = port.find("state")
                if state_elem is None or state_elem.get("state") != "open":
                    continue

                # Numero di porta e protocollo
                port_id = port.get("portid")
                try:
                    port_num = int(port_id) if port_id is not None else None
                except ValueError:
                    port_num = port_id  # in caso di valori non numerici (raro per portid)
                protocol = port.get("protocol", "")

                # Servizio, prodotto e versione (se disponibili)
                service_elem = port.find("service")
                service_name = service_elem.get("name") if service_elem is not None else None
                product = service_elem.get("product", "") if service_elem is not None else ""
                version = service_elem.get("version", "") if service_elem is not None else ""

                # Lista delle vulnerabilità trovate su questa porta
                vulns = []
                # Cerca tra gli output degli script eventuali riferimenti a CVE e punteggi CVSS
                for script_elem in port.findall("script"):
                    output_text = script_elem.get("output") or ""
                    # Regex per trovare pattern "CVE-XXXX-YYYY <score>"
                    matches = re.findall(r"(CVE-\d{4}-\d+)\s+(\d+\.\d+)", output_text)
                    for match in matches:
                        cve_id, score_str = match
                        try:
                            score = float(score_str)
                        except ValueError:
                            score = None
                        vuln_info = {"cve": cve_id}
                        if score is not None:
                            vuln_info["cvss"] = score
                        vulns.append(vuln_info)
                # Crea il dizionario per la porta corrente
                ports_list.append({
                    "port": port_num,
                    "protocol": protocol,
                    "service": service_name,
                    "product": product,
                    "version": version,
                    "vulns": vulns
                })

        # Aggiunge l'host alla lista con informazioni raccolte
        host_info = {
            "ip": ip_address,
            "hostnames": hostnames,
            "ports": ports_list
        }
        result["hosts"].append(host_info)

    return result
