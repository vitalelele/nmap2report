import sys
import click
from pentest_report_gen import parser, report, gui

@click.command(context_settings={"help_option_names": ["-h", "--help"]})
@click.option("--input", "-i", "input_path", required=True,
              help="Path to the Nmap output XML file to analyze")
@click.option("--output", "-o", "output_path", default=None,
              help="Path to the output report file (if not specified, it will be generated automatically)")
@click.option("--format", "-f", "output_format", type=click.Choice(["md", "pdf"], case_sensitive=False),
              default="md", help="Output format: 'md' for Markdown (default) or 'pdf' for PDF")
@click.option("--style", "-s", "report_style", type=click.Choice(["semplice", "corporate"], case_sensitive=False),
              default="semplice", help="Report style: 'semplice' (basic) or 'corporate' (corporate)")
@click.option("--gui", is_flag=True, default=False,
              help="Launch the GUI instead of CLI")
def main(input_path, output_path, output_format, report_style, gui):
    """
    Tool to generate security reports from Nmap XML files.
    """
    if gui:
        gui_run()
        return

    try:
        data = parser.parse_nmap_xml(input_path)
    except Exception as e:
        click.echo(f"Error while parsing the XML file: {e}", err=True)
        sys.exit(1)

    if output_path is None:
        base_name = input_path.rsplit(".", 1)[0]
        output_ext = "md" if output_format.lower() == "md" else "pdf"
        output_path = f"{base_name}_report.{output_ext}"

    try:
        report.generate_report(data, output_path, style=report_style, output_format=output_format.lower())
        click.echo(f"Report generated successfully: {output_path}")
    except report.ReportGenerationError as e:
        click.echo(f"Error during report generation: {e}", err=True)
        sys.exit(2)
    except Exception as e:
        click.echo(f"Unexpected error: {e}", err=True)
        sys.exit(3)

def gui_run():
    """Start the graphical user interface (GUI) for the application."""
    try:
        gui.show_gui()
    except Exception as e:
        click.echo(f"GUI error: {e}", err=True)
        sys.exit(4)

if __name__ == "__main__":
    main()
