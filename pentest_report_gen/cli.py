import sys
import click
from pentest_report_gen import parser, report, gui

@click.command(context_settings={"help_option_names": ["-h", "--help"]})
@click.option("--input", "-i", "input_path", required=True,
              help="Percorso del file XML di output Nmap da analizzare")
@click.option("--output", "-o", "output_path", default=None,
              help="Percorso del file di report in uscita (se non specificato, verrà generato automaticamente)")
@click.option("--format", "-f", "output_format", type=click.Choice(["md", "pdf"], case_sensitive=False),
              default="md", help="Formato di output: 'md' per Markdown (default) o 'pdf' per PDF")
@click.option("--style", "-s", "report_style", type=click.Choice(["semplice", "corporate"], case_sensitive=False),
              default="semplice", help="Stile del report: 'semplice' (base) o 'corporate' (aziendale)")
@click.option("--gui", is_flag=True, default=False,
              help="Avvia la GUI grafica invece della modalità CLI")
def main(input_path, output_path, output_format, report_style, gui):
    """
    Strumento per generare report di sicurezza da file XML di Nmap.
    """
    if gui:
        # Lancia la GUI e ignora gli altri parametri CLI
        gui_run()
        return

    # Parsing del file XML di input
    try:
        data = parser.parse_nmap_xml(input_path)
    except Exception as e:
        click.echo(f"Errore durante il parsing del file XML: {e}", err=True)
        sys.exit(1)

    # Se l'utente non specifica un percorso di output, genera un nome di file predefinito
    if output_path is None:
        base_name = input_path.rsplit(".", 1)[0]  # nome file senza estensione
        output_ext = "md" if output_format.lower() == "md" else "pdf"
        output_path = f"{base_name}_report.{output_ext}"

    try:
        # Genera il report nel formato richiesto
        report.generate_report(data, output_path, style=report_style, output_format=output_format.lower())
        click.echo(f"Report generato con successo: {output_path}")
    except report.ReportGenerationError as e:
        click.echo(f"Errore durante la generazione del report: {e}", err=True)
        sys.exit(2)
    except Exception as e:
        click.echo(f"Errore imprevisto: {e}", err=True)
        sys.exit(3)

def gui_run():
    """Avvia l'interfaccia grafica (GUI) per l'applicazione."""
    try:
        gui.show_gui()
    except Exception as e:
        click.echo(f"Errore nella GUI: {e}", err=True)
        sys.exit(4)

if __name__ == "__main__":
    main()  # Punto di ingresso quando eseguito come script
