import os
import PySimpleGUI as sg
from pentest_report_gen import parser, report

def show_gui():
    """Crea e visualizza la GUI per la generazione del report."""
    sg.theme("SystemDefault")

    # Layout dell'interfaccia
    layout = [
        [sg.Text("File XML di Nmap:"), 
         sg.Input(key="-XMLFILE-", size=(40,1)), 
         sg.FileBrowse(file_types=(("XML Files","*.xml"),), button_text="Sfoglia")],
        [sg.Text("Stile report:"), 
         sg.Combo(values=["semplice", "corporate"], default_value="semplice", key="-STYLE-", readonly=True)],
        [sg.Text("Formato output:"), 
         sg.Combo(values=["Markdown", "PDF"], default_value="Markdown", key="-FORMAT-", readonly=True)],
        [sg.Text("File di output:"), 
         sg.Input(key="-OUTPUT-", size=(40,1)), 
         sg.FileSaveAs(file_types=(("Markdown (*.md)", "*.md"), ("PDF (*.pdf)", "*.pdf")), 
                       default_extension="md", button_text="Scegli")],
        [sg.Button("Genera report", key="-GENERATE-")],
        [sg.StatusBar("", size=(60,1), key="-STATUS-")]
    ]

    window = sg.Window("nmap2report - Genera report di sicurezza", layout)

    # Loop di gestione eventi
    while True:
        event, values = window.read()
        if event == sg.WIN_CLOSED:
            break  # Uscita dall'applicazione

        if event == "-GENERATE-":
            xml_path = values.get("-XMLFILE-")
            chosen_style = values.get("-STYLE-")
            format_choice = values.get("-FORMAT-")
            out_path = values.get("-OUTPUT-")

            # Valida i campi di input
            if not xml_path:
                window["-STATUS-"].update("Seleziona un file XML di input.")
                continue
            if not os.path.isfile(xml_path):
                window["-STATUS-"].update("Il file specificato non esiste.")
                continue

            # Determina lo stile e formato corretti
            style = "semplice" if chosen_style not in ["semplice", "corporate"] else chosen_style
            fmt = "md" if format_choice is None or format_choice.lower().startswith("mark") else "pdf"

            # Se il percorso di output non Ã¨ specificato, imposta un nome predefinito nella cartella dell'input
            if not out_path:
                base = os.path.splitext(xml_path)[0]
                out_path = f"{base}_report.{fmt}"
            else:
                # Aggiunge estensione appropriata se non presente
                if fmt == "md" and not out_path.lower().endswith(".md"):
                    out_path += ".md"
                elif fmt == "pdf" and not out_path.lower().endswith(".pdf"):
                    out_path += ".pdf"

            window["-STATUS-"].update("Generazione in corso...")
            try:
                data = parser.parse_nmap_xml(xml_path)
                report.generate_report(data, out_path, style=style, output_format=fmt)
            except report.ReportGenerationError as e:
                window["-STATUS-"].update(f"Errore nella generazione: {e}")
            except Exception as ex:
                window["-STATUS-"].update(f"Errore: {ex}")
            else:
                window["-STATUS-"].update(f"Report generato: {out_path}")

    window.close()


if __name__ == "__main__":
    show_gui()
